# Render Deployment Guide for BoomCard Backend API

Complete step-by-step guide for deploying the BoomCard backend API to Render.com.

## Prerequisites

- GitHub account with BoomCard repository
- Render.com account (free or paid)
- Stripe account with API keys
- AWS account with S3 bucket configured
- SendGrid account (optional, for emails)

---

## Step 1: Prepare Your Repository

### 1.1 Ensure render.yaml is in the backend-api directory
```bash
ls backend-api/render.yaml
```

### 1.2 Commit and push all changes
```bash
git add backend-api/render.yaml
git commit -m "Add Render deployment configuration"
git push origin master
```

---

## Step 2: Create Render Account

1. Go to [https://render.com](https://render.com)
2. Sign up with your GitHub account
3. Authorize Render to access your repositories
4. Select the BoomCard repository

---

## Step 3: Deploy Using Blueprint

### 3.1 Create New Blueprint

1. In Render Dashboard, click **"New +"** → **"Blueprint"**
2. Connect your GitHub repository
3. Select the `BoomCard` repository
4. Render will automatically detect `backend-api/render.yaml`
5. Review the detected services:
   - ✅ boomcard-api (Web Service)
   - ✅ boomcard-postgres (PostgreSQL Database)
   - ✅ boomcard-redis (Redis Cache)

### 3.2 Configure Service Names

Render will suggest names. You can keep defaults or customize:
- Web Service: `boomcard-api`
- Database: `boomcard-postgres`
- Redis: `boomcard-redis`

### 3.3 Select Plans

**For Development/Testing:**
- Web Service: Starter ($7/month)
- Database: Starter ($7/month)
- Redis: Starter ($10/month)
- **Total: ~$24/month**

**For Production:**
- Web Service: Standard ($25/month) - Recommended for zero-downtime deploys
- Database: Standard ($20/month) - More storage and RAM
- Redis: Standard ($15/month)
- **Total: ~$60/month**

### 3.4 Set Environment Variables

Render will auto-generate some variables. You need to manually set:

**Required Secrets (click "Generate" for JWT secrets):**
```env
JWT_SECRET=<click Generate>
REFRESH_TOKEN_SECRET=<click Generate>
```

**Stripe Configuration:**
```env
STRIPE_SECRET_KEY=sk_live_xxxxx (or sk_test_xxxxx for testing)
STRIPE_PUBLISHABLE_KEY=pk_live_xxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxx (create this in Step 5)
```

**AWS S3 Configuration:**
```env
AWS_ACCESS_KEY_ID=AKIAXXXXXXXXXXXXX
AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
AWS_REGION=eu-west-1
AWS_S3_BUCKET=boomcard-receipts-prod
```

**Optional (but recommended):**
```env
SENDGRID_API_KEY=SG.xxxxx (for email sending)
SENDGRID_FROM_EMAIL=noreply@boomcard.bg
SENTRY_DSN=https://xxxxx@sentry.io/xxxxx (for error tracking)
LOG_LEVEL=info
```

**Auto-configured (do not modify):**
```env
NODE_ENV=production
PORT=3000
DATABASE_URL=<auto-generated from postgres>
REDIS_URL=<auto-generated from redis>
CORS_ORIGIN=https://boomcard.vercel.app
```

### 3.5 Deploy

Click **"Apply"** to start the deployment.

Render will:
1. ✅ Create PostgreSQL database
2. ✅ Create Redis instance
3. ✅ Build your application (`npm ci && prisma generate && npm run build`)
4. ✅ Run migrations (`prisma migrate deploy`)
5. ✅ Start the server (`npm start`)

---

## Step 4: Monitor Deployment

### 4.1 Check Build Logs

1. Click on `boomcard-api` service
2. Go to **"Logs"** tab
3. Watch for:
   ```
   ✓ Built successfully
   ✓ Prisma migrations complete
   ✓ Server listening on port 3000
   ```

### 4.2 Verify Health Check

Once deployed, Render will automatically ping `/health` every 30 seconds.

Check: `https://boomcard-api.onrender.com/health`

Expected response:
```json
{
  "status": "OK",
  "timestamp": "2025-01-04T10:30:00.000Z",
  "uptime": 120,
  "environment": "production"
}
```

### 4.3 Test Database Connection

Check: `https://boomcard-api.onrender.com/ready`

Expected response:
```json
{
  "status": "ready",
  "database": "connected",
  "redis": "connected"
}
```

---

## Step 5: Configure Stripe Webhooks

### 5.1 Get Your Webhook URL

Your Render webhook endpoint:
```
https://boomcard-api.onrender.com/api/webhooks/stripe
```

### 5.2 Create Webhook in Stripe Dashboard

1. Go to [https://dashboard.stripe.com/webhooks](https://dashboard.stripe.com/webhooks)
2. Click **"Add endpoint"**
3. Enter your webhook URL: `https://boomcard-api.onrender.com/api/webhooks/stripe`
4. Select events to listen for:
   - `payment_intent.succeeded`
   - `payment_intent.payment_failed`
   - `charge.refunded`
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.payment_succeeded`
   - `invoice.payment_failed`
5. Click **"Add endpoint"**

### 5.3 Copy Webhook Signing Secret

1. Click on your newly created webhook
2. Reveal the **"Signing secret"** (starts with `whsec_`)
3. Copy the entire secret

### 5.4 Update Environment Variable

1. Go back to Render Dashboard
2. Click on `boomcard-api` service
3. Go to **"Environment"** tab
4. Find `STRIPE_WEBHOOK_SECRET`
5. Paste your signing secret
6. Click **"Save Changes"**
7. Render will automatically redeploy

---

## Step 6: Configure Frontend (Vercel)

Update your Vercel environment variables to point to Render:

### 6.1 In Vercel Dashboard

```env
VITE_API_BASE_URL=https://boomcard-api.onrender.com
VITE_WS_URL=wss://boomcard-api.onrender.com
```

### 6.2 Redeploy Frontend

Vercel will automatically redeploy with new environment variables.

---

## Step 7: Set Up Custom Domain (Optional)

### 7.1 Add Custom Domain in Render

1. In Render Dashboard, go to `boomcard-api` service
2. Click **"Settings"** → **"Custom Domains"**
3. Click **"Add Custom Domain"**
4. Enter your domain (e.g., `api.boomcard.bg`)
5. Render will provide DNS instructions

### 7.2 Configure DNS

Add CNAME record in your DNS provider:
```
Type: CNAME
Name: api
Value: boomcard-api.onrender.com
TTL: 3600
```

### 7.3 Update CORS

Once custom domain is active, update `CORS_ORIGIN`:
```env
CORS_ORIGIN=https://boomcard.bg,https://www.boomcard.bg,https://boomcard.vercel.app
```

---

## Step 8: Database Management

### 8.1 Access Database via Render Dashboard

1. Click on `boomcard-postgres` database
2. Go to **"Info"** tab
3. Copy connection details:
   - Internal Database URL (for app)
   - External Database URL (for local access)

### 8.2 Connect Locally (Optional)

Using `psql`:
```bash
psql <External Database URL>
```

Using Prisma Studio:
```bash
cd backend-api
DATABASE_URL="<External Database URL>" npx prisma studio
```

### 8.3 Run Migrations Manually (if needed)

```bash
cd backend-api
DATABASE_URL="<External Database URL>" npx prisma migrate deploy
```

---

## Step 9: Monitoring & Logs

### 9.1 View Real-Time Logs

1. Go to `boomcard-api` service
2. Click **"Logs"** tab
3. Use filters:
   - **All logs**: Everything
   - **Errors only**: Just errors
   - **Search**: Filter by keyword

### 9.2 Set Up Log Drains (Optional)

Forward logs to external services:
1. Click **"Settings"** → **"Log Drains"**
2. Add drain URL (e.g., Datadog, Loggly, Papertrail)

### 9.3 Enable Notifications

1. Go to **"Settings"** → **"Notifications"**
2. Enable:
   - Deploy notifications
   - Crash notifications
   - Health check failures
3. Add Slack/Discord webhook or email

---

## Step 10: Scaling & Performance

### 10.1 Vertical Scaling (Upgrade Plan)

For better performance:
- Upgrade to **Standard** or **Pro** plan
- More CPU and RAM
- Zero-downtime deploys

### 10.2 Horizontal Scaling (Multiple Instances)

Pro plan and above:
1. Go to **"Settings"** → **"Scaling"**
2. Increase instance count (2-10 instances)
3. Render automatically load balances

### 10.3 Enable Auto-Scaling (Enterprise)

Enterprise plan:
- Automatically scale based on CPU/memory
- Set min/max instance count

---

## Step 11: Security Hardening

### 11.1 Restrict Database Access

1. Go to `boomcard-postgres` database
2. **"Settings"** → **"Security"**
3. **"IP Allow List"** → Add only Render IPs
4. Remove "0.0.0.0/0" (allow all)

### 11.2 Enable Web Application Firewall

Consider adding Cloudflare:
1. Add your domain to Cloudflare
2. Enable WAF rules
3. Set up rate limiting
4. Enable DDoS protection

### 11.3 Regular Security Audits

```bash
cd backend-api
npm audit
npm audit fix
```

---

## Step 12: Backup & Disaster Recovery

### 12.1 Database Backups

Render automatically backs up databases:
- **Starter plan**: Daily backups, 7-day retention
- **Standard plan**: Daily backups, 30-day retention
- **Pro plan**: Daily backups, 60-day retention

### 12.2 Manual Backup

Create manual backup:
```bash
pg_dump "<External Database URL>" > backup.sql
```

### 12.3 Restore from Backup

```bash
psql "<External Database URL>" < backup.sql
```

---

## Troubleshooting

### Issue: Build Fails

**Symptoms:** Deployment stuck in "Building" or fails

**Solutions:**
1. Check build logs for errors
2. Verify `package.json` scripts
3. Ensure Prisma schema is valid: `npx prisma validate`
4. Clear build cache: Settings → "Clear Build Cache"

### Issue: Database Connection Fails

**Symptoms:** `ECONNREFUSED` or `Connection refused`

**Solutions:**
1. Verify `DATABASE_URL` is set correctly
2. Check database is running (green status)
3. Run migrations manually
4. Restart web service

### Issue: Health Check Fails

**Symptoms:** Service shows as "Unhealthy"

**Solutions:**
1. Check `/health` endpoint works locally
2. Verify health check path in render.yaml
3. Increase health check timeout
4. Check server is listening on correct port (3000)

### Issue: Stripe Webhooks Not Working

**Symptoms:** Payments succeed but app doesn't update

**Solutions:**
1. Verify webhook URL is correct
2. Check `STRIPE_WEBHOOK_SECRET` is set
3. View Stripe webhook logs for errors
4. Test webhook locally with Stripe CLI

### Issue: High Memory Usage

**Symptoms:** Service crashes or restarts frequently

**Solutions:**
1. Upgrade to larger plan
2. Optimize database queries
3. Add Redis caching
4. Check for memory leaks

### Issue: Slow Response Times

**Symptoms:** API requests take >2 seconds

**Solutions:**
1. Enable Redis caching
2. Optimize database indexes
3. Add CDN (Cloudflare)
4. Upgrade database plan
5. Enable horizontal scaling

---

## Cost Optimization

### Development Environment
- Use free PostgreSQL (512MB)
- Skip Redis (cache in memory)
- Use Starter web service
- **Cost: ~$7/month**

### Production Environment (Recommended)
- Standard web service: $25/month
- Standard database: $20/month
- Standard Redis: $15/month
- **Cost: ~$60/month**

### High-Traffic Production
- Pro web service (2+ instances): $85/month
- Pro database: $90/month
- Pro Redis: $30/month
- **Cost: ~$205/month**

---

## Monitoring Checklist

After deployment, verify:

- ✅ Health check passing (`/health` returns 200)
- ✅ Database connection working (`/ready` returns 200)
- ✅ Stripe webhooks configured
- ✅ CORS allows your frontend domain
- ✅ Logs are clean (no errors)
- ✅ Environment variables set correctly
- ✅ Migrations ran successfully
- ✅ Redis connected
- ✅ Test endpoints respond correctly
- ✅ Error tracking (Sentry) working
- ✅ Notifications configured

---

## Next Steps

1. **Set up monitoring**: Add Sentry, New Relic, or Datadog
2. **Configure alerts**: Get notified of crashes/errors
3. **Load testing**: Test with Artillery or k6
4. **Performance tuning**: Optimize slow queries
5. **Security audit**: Run penetration testing
6. **Documentation**: Update API docs with production URLs

---

## Useful Links

- [Render Documentation](https://render.com/docs)
- [Render Status Page](https://status.render.com/)
- [Render Community](https://community.render.com/)
- [Prisma Render Guide](https://www.prisma.io/docs/guides/deployment/deployment-guides/deploying-to-render)
- [Stripe Webhooks Guide](https://stripe.com/docs/webhooks)

---

## Support

**Render Support:**
- Dashboard: Help icon (bottom right)
- Email: support@render.com
- Community: community.render.com

**BoomCard Team:**
- GitHub Issues: https://github.com/your-repo/issues
- Email: support@boomcard.bg

---

**Deployment Date:** _____________________
**Deployed By:** _____________________
**Environment:** Production / Staging / Development
**Version:** v1.0.0

// BoomCard Partner Dashboard - Prisma Schema
// Database: SQLite (development) / PostgreSQL (production)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication Models
// ============================================

enum UserRole {
  USER
  PARTNER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

model User {
  id                String      @id @default(uuid())
  email             String      @unique
  passwordHash      String
  firstName         String?
  lastName          String?
  phone             String?
  avatar            String?
  role              UserRole    @default(USER)
  status            UserStatus  @default(PENDING_VERIFICATION)
  emailVerified     Boolean     @default(false)
  emailVerifiedAt   DateTime?
  lastLoginAt       DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  refreshTokens     RefreshToken[]
  partner           Partner?
  transactions      Transaction[]
  loyaltyAccount    LoyaltyAccount?
  conversations     ConversationParticipant[]
  messages          Message[]
  notifications     Notification[]
  bookings          Booking[]
  reviews           Review[]
  favorites         Favorite[]

  @@index([email])
  @@index([role])
  @@index([status])
}

model RefreshToken {
  id          String    @id @default(uuid())
  token       String    @unique
  userId      String
  expiresAt   DateTime
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

// ============================================
// Partner Models
// ============================================

enum PartnerTier {
  BASIC
  STANDARD
  PREMIUM
  VIP
  EXCLUSIVE
}

enum PartnerStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

model Partner {
  id                String          @id @default(uuid())
  userId            String          @unique
  businessName      String
  businessNameBg    String?
  category          String
  description       String?
  descriptionBg     String?
  logo              String?
  coverImage        String?
  tier              PartnerTier     @default(BASIC)
  status            PartnerStatus   @default(PENDING)
  rating            Float           @default(0)
  reviewCount       Int             @default(0)
  website           String?
  phone             String?
  email             String?
  address           String?
  city              String?
  region            String?
  latitude          Float?
  longitude         Float?
  openingHours      String?         // JSON string
  features          String?         // JSON string
  amenities         String?         // JSON string
  joinedAt          DateTime        @default(now())
  verifiedAt        DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  venues            Venue[]
  offers            Offer[]
  reviews           Review[]
  bookings          Booking[]
  transactions      Transaction[]

  @@index([category])
  @@index([tier])
  @@index([status])
  @@index([city])
}

model Venue {
  id              String      @id @default(uuid())
  partnerId       String
  name            String
  nameBg          String?
  address         String
  city            String
  region          String?
  latitude        Float
  longitude       Float
  phone           String?
  email           String?
  description     String?
  descriptionBg   String?
  images          String?     // JSON array
  openingHours    String?     // JSON string
  capacity        Int?
  features        String?     // JSON array
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  partner         Partner     @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  bookings        Booking[]

  @@index([partnerId])
  @@index([city])
}

// ============================================
// Offers & Promotions
// ============================================

enum OfferStatus {
  DRAFT
  ACTIVE
  PAUSED
  EXPIRED
  CANCELLED
}

enum OfferType {
  DISCOUNT
  CASHBACK
  POINTS
  BUNDLE
  SEASONAL
}

model Offer {
  id                String        @id @default(uuid())
  partnerId         String
  title             String
  titleBg           String?
  description       String
  descriptionBg     String?
  type              OfferType
  discountPercent   Float?
  discountAmount    Float?
  cashbackPercent   Float?
  pointsMultiplier  Float?
  minPurchase       Float?
  maxDiscount       Float?
  termsConditions   String?
  termsConditionsBg String?
  image             String?
  status            OfferStatus   @default(DRAFT)
  startDate         DateTime
  endDate           DateTime
  usageLimit        Int?
  usageCount        Int           @default(0)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  partner           Partner       @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  transactions      Transaction[]

  @@index([partnerId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

// ============================================
// Transactions & Payments
// ============================================

enum TransactionType {
  BOOKING
  PURCHASE
  WALLET_TOPUP
  REFUND
  LOYALTY_REDEMPTION
  SUBSCRIPTION
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CARD
  WALLET
  BANK_TRANSFER
  CASH
}

model Transaction {
  id                String              @id @default(uuid())
  userId            String
  partnerId         String?
  offerId           String?
  bookingId         String?
  type              TransactionType
  status            TransactionStatus
  amount            Float
  currency          String              @default("BGN")
  paymentMethod     PaymentMethod
  paymentIntentId   String?
  stripePaymentId   String?
  description       String?
  descriptionBg     String?
  metadata          String?             // JSON string
  loyaltyPoints     Int?
  cashbackAmount    Float?
  processingFee     Float?
  netAmount         Float?
  refundedAmount    Float?
  refundedAt        DateTime?
  completedAt       DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  user              User                @relation(fields: [userId], references: [id])
  partner           Partner?            @relation(fields: [partnerId], references: [id])
  offer             Offer?              @relation(fields: [offerId], references: [id])
  booking           Booking?            @relation(fields: [bookingId], references: [id])

  @@index([userId])
  @@index([partnerId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// Loyalty & Rewards
// ============================================

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

model LoyaltyAccount {
  id                String        @id @default(uuid())
  userId            String        @unique
  tier              LoyaltyTier   @default(BRONZE)
  points            Int           @default(0)
  lifetimePoints    Int           @default(0)
  tierProgress      Float         @default(0)
  cashbackBalance   Float         @default(0)
  nextTierPoints    Int?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions      LoyaltyTransaction[]
  rewards           RewardRedemption[]
  badges            UserBadge[]

  @@index([userId])
  @@index([tier])
}

enum LoyaltyTransactionType {
  EARNED
  REDEEMED
  EXPIRED
  ADJUSTED
  BONUS
}

model LoyaltyTransaction {
  id              String                  @id @default(uuid())
  accountId       String
  type            LoyaltyTransactionType
  points          Int
  description     String?
  descriptionBg   String?
  metadata        String?                 // JSON string
  expiresAt       DateTime?
  createdAt       DateTime                @default(now())

  account         LoyaltyAccount          @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([createdAt])
}

model Reward {
  id                String        @id @default(uuid())
  title             String
  titleBg           String?
  description       String
  descriptionBg     String?
  pointsCost        Int
  cashValue         Float?
  category          String
  image             String?
  isActive          Boolean       @default(true)
  stockQuantity     Int?
  redeemedCount     Int           @default(0)
  validFrom         DateTime      @default(now())
  validUntil        DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  redemptions       RewardRedemption[]

  @@index([category])
  @@index([isActive])
}

enum RedemptionStatus {
  PENDING
  APPROVED
  REJECTED
  USED
  EXPIRED
}

model RewardRedemption {
  id              String            @id @default(uuid())
  accountId       String
  rewardId        String
  status          RedemptionStatus  @default(PENDING)
  pointsSpent     Int
  code            String?
  expiresAt       DateTime?
  usedAt          DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  account         LoyaltyAccount    @relation(fields: [accountId], references: [id])
  reward          Reward            @relation(fields: [rewardId], references: [id])

  @@index([accountId])
  @@index([rewardId])
  @@index([status])
}

model Badge {
  id              String      @id @default(uuid())
  name            String      @unique
  nameBg          String?
  description     String
  descriptionBg   String?
  icon            String?
  category        String
  requirement     String      // JSON string defining unlock conditions
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())

  userBadges      UserBadge[]

  @@index([category])
}

model UserBadge {
  id              String          @id @default(uuid())
  accountId       String
  badgeId         String
  unlockedAt      DateTime        @default(now())

  account         LoyaltyAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  badge           Badge           @relation(fields: [badgeId], references: [id])

  @@unique([accountId, badgeId])
  @@index([accountId])
}

// ============================================
// Bookings
// ============================================

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

model Booking {
  id                String          @id @default(uuid())
  userId            String
  partnerId         String
  venueId           String?
  bookingDate       DateTime
  bookingTime       String
  guestCount        Int
  specialRequests   String?
  specialRequestsBg String?
  status            BookingStatus   @default(PENDING)
  confirmationCode  String?         @unique
  notes             String?
  notesInternal     String?
  cancelledAt       DateTime?
  cancellationReason String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  user              User            @relation(fields: [userId], references: [id])
  partner           Partner         @relation(fields: [partnerId], references: [id])
  venue             Venue?          @relation(fields: [venueId], references: [id])
  transactions      Transaction[]

  @@index([userId])
  @@index([partnerId])
  @@index([status])
  @@index([bookingDate])
}

// ============================================
// Reviews & Ratings
// ============================================

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

model Review {
  id              String        @id @default(uuid())
  userId          String
  partnerId       String
  rating          Int
  title           String?
  comment         String?
  images          String?       // JSON array
  status          ReviewStatus  @default(PENDING)
  isVerified      Boolean       @default(false)
  helpful         Int           @default(0)
  notHelpful      Int           @default(0)
  adminResponse   String?
  adminRespondedAt DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user            User          @relation(fields: [userId], references: [id])
  partner         Partner       @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([partnerId])
  @@index([status])
  @@index([rating])
}

// ============================================
// Messaging
// ============================================

enum ConversationType {
  DIRECT
  GROUP
  SUPPORT
}

model Conversation {
  id              String                    @id @default(uuid())
  type            ConversationType          @default(DIRECT)
  title           String?
  lastMessageAt   DateTime?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  participants    ConversationParticipant[]
  messages        Message[]

  @@index([lastMessageAt])
}

model ConversationParticipant {
  id                String        @id @default(uuid())
  conversationId    String
  userId            String
  joinedAt          DateTime      @default(now())
  lastReadAt        DateTime?
  isActive          Boolean       @default(true)

  conversation      Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

model Message {
  id              String        @id @default(uuid())
  conversationId  String
  userId          String
  type            MessageType   @default(TEXT)
  content         String
  attachments     String?       // JSON array
  isEdited        Boolean       @default(false)
  editedAt        DateTime?
  deletedAt       DateTime?
  createdAt       DateTime      @default(now())

  conversation    Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id])

  @@index([conversationId])
  @@index([userId])
  @@index([createdAt])
}

// ============================================
// Notifications
// ============================================

enum NotificationType {
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  LOYALTY_POINTS
  REWARD_AVAILABLE
  NEW_MESSAGE
  REVIEW_RECEIVED
  OFFER_EXPIRING
  SYSTEM
}

model Notification {
  id              String            @id @default(uuid())
  userId          String
  type            NotificationType
  title           String
  titleBg         String?
  message         String
  messageBg       String?
  data            String?           // JSON string
  isRead          Boolean           @default(false)
  readAt          DateTime?
  createdAt       DateTime          @default(now())

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================
// Favorites
// ============================================

model Favorite {
  id              String      @id @default(uuid())
  userId          String
  partnerId       String?
  offerId         String?
  venueId         String?
  createdAt       DateTime    @default(now())

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, partnerId])
  @@index([userId])
}
